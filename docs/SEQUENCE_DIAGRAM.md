# SEQUENCE DIAGRAM

## 콘서트 예약 시퀀스 다이어그램

전체 콘서트 예약 시퀀스 다이어그램은 자세한 분기처리는 생략하여 성공케이스 위주로 작성하였습니다.  
자세한 분기처리는 각 Use Case별 시퀀스 다이어그램을 참고해주세요.

```mermaid
sequenceDiagram
    actor User
    participant 대기열 검증
    participant API
    participant 사용자
    participant 잔액
    participant 콘서트
    participant 콘서트 좌석 예약 해제 스케줄링
    participant 대기열 토큰
    participant 대기열 스케줄링
    title 콘서트 예약 시퀀스 다이어그램
    User ->> API: 대기열 토큰 생성 API 요청
    API ->> 대기열 토큰: 대기열 토큰 생성 요청
    대기열 토큰 ->> 대기열 토큰: 대기열 토큰 생성 요청
    대기열 토큰 -->> API: 대기열 토큰 반환
    API -->> User: 대기열 토큰 반환

    loop 5초마다
        대기열 스케줄링 ->> 대기열 토큰: 만료시간이 지난 활성 대기열 토큰 조회 요청
        대기열 토큰 ->> 대기열 스케줄링: 만료시간이 지난 활성 대기열 토큰 반환
        opt 만료시간이 지난 활성 대기열 토큰이 있을 경우
            대기열 스케줄링 ->> 대기열 토큰: 만료시간이 지난 활성 대기열 토큰 만료 요청
            대기열 토큰 -->> 대기열 스케줄링: 만료시간이 지난 활성 대기열 토큰 만료 성공 반환
        end

        대기열 스케줄링 ->> 대기열 토큰: 활성 대기열 토큰 수 조회
        대기열 토큰 ->> 대기열 스케줄링: 활성 대기열 토큰 수 반환
        opt 활성 대기열 자리에 여유가 있는 경우
            대기열 스케줄링 ->> 대기열 토큰: 대기 대기열 순서대로 활성화 요청
            대기열 토큰 ->> 대기열 스케줄링: 대기 대기열 순서대로 활성화 성공 반환
        end
    end

    loop 5초마다
        사용자 -->> 대기열 검증: 토큰 검증이 필요한 API 요청
        note over 사용자, 대기열 검증: 헤더에 대기열 토큰 정보 포함
        대기열 검증 ->> 대기열 토큰: 대기열 토큰 조회 요청
        대기열 토큰 ->> 대기열 검증: 대기열 토큰 반환
        opt 활성 대기열이 아닐 경우
            대기열 검증 --> 대기열 토큰: 남은 대기 순서 요청
            대기열 토큰 --> 대기열 검증: 남은 대기 순서 반환
            대기열 검증 ->> User: 남은 대기 순서 반환
        end
    end

    User ->> 대기열 검증: 예약 가능 날짜 조회 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 예약 가능 날짜 조회 API 요청
    API ->> 콘서트: 예약 가능 날짜 조회 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    콘서트 ->> 콘서트: 예약 가능 날짜 조회
    콘서트 ->> API: 예약 가능 날짜 반환
    API -->> User: 예약 가능 날짜 반환
    User ->> 대기열 검증: 예약 가능 좌석 조회 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 예약 가능 좌석 조회 API 요청
    API ->> 콘서트: 예약 가능 좌석 조회 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    콘서트 ->> 콘서트: 예약 가능 좌석 조회
    콘서트 ->> API: 예약 가능 좌석 반환
    API -->> User: 예약 가능 좌석 반환
    User ->> 대기열 검증: 좌석 예약 요청 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 좌석 예약 요청 API 요청
    API ->> 콘서트: 좌석 예약 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    콘서트 ->> 콘서트: 좌석 예약
    콘서트 -->> API: 좌석 예약 성공 반환
    API -->> User: 좌석 예약 성공 반환
    User ->> 대기열 검증: 잔액 충전 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 잔액 충전 API 요청
    API ->> 잔액: 잔액 충전 요청
    잔액 ->> 사용자: 사용자 조회 요청
    사용자 -->> 잔액: 사용자 반환
    잔액 ->> 잔액: 잔액 충전
    잔액 -->> API: 잔액 충전 성공 반환
    API -->> User: 잔액 충전 성공 반환
    User ->> 대기열 검증: 잔액 조회 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 잔액 조회 API 요청
    API ->> 잔액: 잔액 조회 요청
    잔액 ->> 사용자: 사용자 조회 요청
    사용자 -->> 잔액: 사용자 반환
    잔액 ->> 잔액: 잔액 조회
    잔액 -->> API: 잔액 조회 성공 반환
    API -->> User: 잔액 조회 성공 반환
    User ->> 대기열 검증: 결제 API 요청
    대기열 검증 ->> API: [대기열 검증 통과] 결제 API 요청
    API ->> 콘서트: 결제 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    콘서트 ->> 잔액: 잔액 차감 요청
    잔액 ->> 콘서트: 잔액 차감 성공 반환
    콘서트 ->> 콘서트: 좌석 예약 완료
    콘서트 -) 대기열 토큰: 대기열 만료 요청
    콘서트 -->> API: 결제 성공 반환
    API -->> User: 결제 성공 반환

    loop 1분마다 재 요청 (콘서트 좌석 예약 해제 스케줄링)
        콘서트 좌석 예약 해제 스케줄링 ->> 콘서트: 임시 예약 5분 지난 좌석 해제 요청
        콘서트 ->> 콘서트: 임시 예약 5분 지난 좌석 해제
    end
```

### 대기열 토큰 생성

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 대기열 토큰
    title 대기열 토큰 생성 시퀀스 다이어그램
    User ->> API: 대기열 토큰 생성 API 요청
    API ->> 대기열 토큰: 대기열 토큰 생성 요청
    대기열 토큰 ->> 대기열 토큰: 대기열 토큰 생성
    대기열 토큰 -->> API: 대기열 토큰 반환
    API -->> User: 대기열 토큰 반환
```

### 대기열 토큰 기능

```mermaid
sequenceDiagram
    actor User
    participant 대기열 검증
    participant API
    participant 대기열 토큰
    title 대기열 토큰 기능 시퀀스 다이어그램

    loop 5초마다 재 요청 (대기열 검증 통과할때 까지)
        User ->> 대기열 검증: 토큰 검증이 필요한 API 요청
        note over User, 대기열 검증: 헤더에 대기열 토큰 정보 포함
        대기열 검증 ->> 대기열 토큰: 대기열 토큰 조회 요청
        대기열 토큰 ->> 대기열 검증: 대기열 토큰 반환
        opt 만료된 토큰일 경우
            대기열 검증 ->> User: 토큰 만료 반환
        end

        opt 대기열 토큰이 대기 상태인 경우
            대기열 검증 ->> 대기열 토큰: 대기열 순번 요청
            대기열 토큰 -->> 대기열 검증: 대기열 순번 반환
            대기열 검증 -->> User: 대기열 순번 반환
        end

        대기열 검증 -->> 대기열 검증: 대기열 검증 통과
    end

    대기열 검증 ->> API: [대기열 검증 통과] 토큰 검증이 필요한 API 요청
    API -->> User: API 응답 반환
```

### 예약 가능 날짜 조회

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 콘서트
    participant 사용자
    title 예약 가능 날짜 조회 시퀀스 다이어그램
    User ->> API: [대기열 검증 통과] 예약 가능 날짜 조회 API 요청
    API ->> 콘서트: 예약 가능 날짜 조회 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    opt 사용자가 없을 경우
        콘서트 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    콘서트 ->> 콘서트: 예약 가능 날짜 조회
    콘서트 ->> API: 예약 가능 날짜 반환
    API -->> User: 예약 가능 날짜 반환
```

### 예약 가능 좌석 조회

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 콘서트
    participant 사용자
    title 예약 가능 좌석 조회 시퀀스 다이어그램
    User ->> API: [대기열 검증 통과] 예약 가능 좌석 조회 API 요청
    API ->> 콘서트: 예약 가능 좌석 조회 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    opt 사용자가 없을 경우
        콘서트 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 조회
    opt 콘서트가 없을 경우
        콘서트 -->> API: 콘서트 없음 반환
        API -->> User: 콘서트 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 날짜 조회
    opt 콘서트 날짜가 없을 경우
        콘서트 -->> API: 콘서트 날짜 없음 반환
        API -->> User: 콘서트 날짜 없음 반환
    end

    콘서트 ->> 콘서트: 예약 가능 좌석 조회
    콘서트 ->> API: 예약 가능 좌석 반환
    API -->> User: 예약 가능 좌석 반환
```

### 좌석 예약 요청 API

여기서 좌석 예약은 결제가 진행되지않은 임시 예약 상태입니다.

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 콘서트
    participant 사용자
    title 좌석 예약 요청 시퀀스 다이어그램
    User ->> API: [대기열 검증 통과] 좌석 예약 요청 API 요청
    API ->> 콘서트: 좌석 예약 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    opt 사용자가 없을 경우
        콘서트 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 조회
    opt 콘서트가 없을 경우
        콘서트 -->> API: 콘서트 없음 반환
        API -->> User: 콘서트 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 날짜 조회
    opt 콘서트 날짜가 없을 경우
        콘서트 -->> API: 콘서트 날짜 없음 반환
        API -->> User: 콘서트 날짜 없음 반환
    end

    콘서트 ->> 콘서트: 좌석 조회
    opt 좌석이 없을 경우
        콘서트 -->> API: 좌석 없음 반환
        API -->> User: 좌석 없음 반환
    end

    콘서트 ->> 콘서트: 좌석 예약
    opt 좌석 예약이 불가능 한 경우
        콘서트 -->> API: 좌석 예약 불가 반환
        API -->> User: 좌석 예약 불가 반환
    end

    콘서트 -->> API: 좌석 예약 성공 반환
    API -->> User: 좌석 예약 성공 반환
```

### 잔액 충전

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 잔액
    participant 사용자
    title 잔액 충전 시퀀스 다이어그램
    User ->> API: 잔액 충전 API 요청
    API ->> 잔액: 잔액 충전 요청
    잔액 ->> 사용자: 사용자 조회 요청
    사용자 -->> 잔액: 사용자 반환
    opt 사용자가 없을 경우
        잔액 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    opt 충전 불가능한 금액인 경우
        잔액 -->> API: 충전 불가 반환
        API -->> User: 충전 불가 반환
    end

    잔액 ->> 잔액: 잔액 충전
    잔액 -->> API: 잔액 충전 성공 반환
    API -->> User: 잔액 충전 성공 반환
```

### 잔액 조회 API

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 잔액
    participant 사용자
    title 잔액 조회 시퀀스 다이어그램
    User ->> API: 잔액 조회 API 요청
    API ->> 잔액: 잔액 조회 요청
    잔액 ->> 사용자: 사용자 조회 요청
    사용자 -->> 잔액: 사용자 반환
    opt 사용자가 없을 경우
        잔액 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    잔액 ->> 잔액: 잔액 조회
    잔액 -->> API: 잔액 조회 성공 반환
    API -->> User: 잔액 조회 성공 반환
```

### 결제 API

```mermaid
sequenceDiagram
    actor User
    participant API
    participant 콘서트
    participant 사용자
    participant 잔액
    participant 대기열 토큰
    title 결제 시퀀스 다이어그램
    User ->> API: [대기열 검증 통과] 결제 API 요청
    API ->> 콘서트: 결제 요청
    콘서트 ->> 사용자: 사용자 조회 요청
    사용자 -->> 콘서트: 사용자 반환
    opt 사용자가 없을 경우
        콘서트 -->> API: 사용자 없음 반환
        API -->> User: 사용자 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 조회
    opt 콘서트가 없을 경우
        콘서트 -->> API: 콘서트 없음 반환
        API -->> User: 콘서트 없음 반환
    end

    콘서트 ->> 콘서트: 콘서트 날짜 조회
    opt 콘서트 날짜가 없을 경우
        콘서트 -->> API: 콘서트 날짜 없음 반환
        API -->> User: 콘서트 날짜 없음 반환
    end

    콘서트 ->> 콘서트: 좌석 조회
    opt 좌석이 없을 경우
        콘서트 -->> API: 좌석 없음 반환
        API -->> User: 좌석 없음 반환
    end

    opt 본인이 임시예약한 좌석이 아닌 경우
        콘서트 -->> API: 임시예약 좌석 아님 반환
        API -->> User: 임시예약 좌석 아님 반환
    end

    콘서트 ->> 사용자: 사용자 잔액 조회 요청
    사용자 -->> 콘서트: 사용자 잔액 반환
    opt 사용자 잔액이 부족한 경우
        콘서트 -->> API: 잔액 부족 반환
        API -->> User: 잔액 부족 반환
    end

    콘서트 ->> 잔액: 잔액 차감
    잔액 ->> 콘서트: 잔액 차감 성공 반환
    콘서트 ->> 콘서트: 좌석 예약 완료
    콘서트 -) 대기열 토큰: 대기열 만료 요청
    콘서트 -->> API: 결제 성공 반환
    API -->> User: 결제 성공 반환
```